((function(){var a,b,c,d,e,f,g,h,i,j,k,l=function(a,b){return function(){return a.apply(b,arguments)}},m=Object.prototype.hasOwnProperty,n=function(a,b){function d(){this.constructor=a}for(var c in b)m.call(b,c)&&(a[c]=b[c]);d.prototype=b.prototype;a.prototype=new d;a.__super__=b.prototype;return a};k=[{name:"Top 300",id:1e3,genreId:34},{name:"J-Pop",id:1024,genreId:27},{name:"R&B／ソウル",id:1010,genreId:15},{name:"アニメ",id:27743,genreId:29},{name:"エレクトロニック",id:1004,genreId:7},{name:"オルタナティブ",id:1015,genreId:20},{name:"クラシック",id:1002,genreId:5},{name:"サウンドトラック",id:1011,genreId:16},{name:"ジャズ",id:1006,genreId:11},{name:"ダンス",id:1012,genreId:17},{name:"ヒップホップ／ラップ",id:1013,genreId:18},{name:"フィットネス／エクササイズ",id:27800,genreId:50},{name:"ブルース",id:1001,genreId:2},{name:"ポップ",id:1009,genreId:14},{name:"レゲエ",id:1031,genreId:24},{name:"ロック",id:1017,genreId:21},{name:"ワールド",id:1014,genreId:19},{name:"ヴォーカル",id:1016,genreId:23},{name:"歌謡曲",id:1025,genreId:30}];b=function(){function a(){}a.expoEaseOut=function(a,b,c,d){b==null&&(b=0);c==null&&(c=1);d==null&&(d=1);return a===0?b:c*Math.pow(2,10*(a/d-1))+b-c*.001};return a}();d=function(){function a(){}a.toRGBA=function(a,b,c,d){var e,f,g,h,i,j,k,l,m;d==null&&(d=1);f=a/60;h=f^0;j=c-c*b;i=c*b*(f-h);k=c-i;l=i+j;m=[c,k,j,j,l,c][h]*255^0;g=[l,c,c,k,j,j][h]*255^0;e=[j,j,l,c,c,k][h]*255^0;return"rgba("+m+","+g+","+e+","+d+")"};return a}();j=function(){function a(){}a.volume=0;a.init=function(b){var c;c=$.cookie("volume")||.8;a.volume=c;b.val(c*100);return b.on("change",function(){a.volume=b.val()/100;return $.cookie("volume",a.volume,{path:"/"})})};return a}();e=function(){function c(a){this.onEnded=l(this.onEnded,this);this.onInterval=l(this.onInterval,this);this.onLoadedMetaData=l(this.onLoadedMetaData,this);this.stop=l(this.stop,this);this.play=l(this.play,this);_.extend(this,Backbone.Events);this.audio=new Audio;this.audio.volume=0;this.audio.autoPlay=!1;this.audio.loop=!1;this.audio.addEventListener("loadedmetadata",this.onLoadedMetaData);this.audio.addEventListener("ended",this.onEnded);this.stopped=!1}var a;a=3;c.current=null;c.prototype.play=function(a){var b;(b=c.current)!=null&&b.stop();this.audio.src=a;c.current=this;return this.trigger("start")};c.prototype.stop=function(){this.stopped=!0;this.audio.pause();clearInterval(this.id);return this.trigger("stop")};c.prototype.onLoadedMetaData=function(){if(this.stopped)return;this.audio.play();return this.id=setInterval(this.onInterval,50)};c.prototype.onInterval=function(){var c,d;d=1;c=this.audio.currentTime;c<a?d=Math.max(0,c/a):this.audio.duration-c<a&&(d=Math.max(0,(this.audio.duration-c)/a));return this.audio.volume=b.expoEaseOut(d*j.volume)};c.prototype.onEnded=function(){this.stop();return this.trigger("complete")};return c}();h=function(a){function b(){this.stop=l(this.stop,this);this.play=l(this.play,this);b.__super__.constructor.apply(this,arguments)}n(b,a);b.prototype.play=function(){var a=this;this.player=new e;this.player.bind("all",function(b){return a.trigger.apply(a,[b,a])});return this.player.play(this.get("audioUrl"))};b.prototype.stop=function(){return this.player.stop()};return b}(Backbone.Model);i=function(a){function b(){this.onClickStatus=l(this.onClickStatus,this);this.onStop=l(this.onStop,this);this.onStart=l(this.onStart,this);this.onClick=l(this.onClick,this);this.onMouseLeave=l(this.onMouseLeave,this);this.onMouseEnter=l(this.onMouseEnter,this);this.onImageLoaded=l(this.onImageLoaded,this);this.render=l(this.render,this);b.__super__.constructor.apply(this,arguments)}n(b,a);b.prototype.tagName="div";b.prototype.className="cover";b.prototype.template=Haml('%img(src=imageUrl)\n.black\n    .info\n        .title &= itemName\n        .artist &= artistName\n        %a.itunes(href=storeUrl target="_blank")\n            %img.badge(src="/images/badge_itunes-sm.gif")\n.rank(style=color) = rank');b.prototype.events={mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"};b.prototype.initialize=function(){this.model.view=this;this.model.bind("start",this.onStart);this.model.bind("stop",this.onStop);return this.el=$(this.el)};b.prototype.render=function(){var a;a=this.model.toJSON();a.rank=a.order+1;a.color="background-color: "+d.toRGBA(a.rank,1,.95,.7);this.el.html(this.template(a));this.image=$(">img",this.el);this.image.hide();this.image.load(this.onImageLoaded);this.black=$(".black",this.el);this.black.click(this.onClick);this.black.hide();this.rank=$(".rank",this.el);this.rank.hide();return this};b.prototype.onImageLoaded=function(a){var b,c,d,e;c=a.target;e=c.width;b=c.height;d=150/Math.min(e,b);e*=d;b*=d;$(c).css({width:e,height:b,left:(150-e)/2+"px",top:(150-b)/2+"px"});return this.image.fadeIn(300)};b.prototype.onMouseEnter=function(a){this.black.fadeIn(300);return this.rank.fadeIn(300)};b.prototype.onMouseLeave=function(a){this.black.fadeOut(300);if(!this.el.hasClass("playing"))return this.rank.fadeOut(300)};b.prototype.onClick=function(a){if(a.target.className!=="badge")return this.el.hasClass("playing")?this.model.stop():this.model.play()};b.prototype.onStart=function(){this.el.addClass("playing");this.rank.fadeIn(300);$("#status").text(this.model.get("order")+1+". "+this.model.get("itemName")+" - "+this.model.get("artistName"));return $("#status").on("click",this.onClickStatus)};b.prototype.onStop=function(){this.el.removeClass("playing");this.rank.fadeOut(300);$("#status").text("");return $("#status").off("click",this.onClickStatus)};b.prototype.onClickStatus=function(){var a,b,c;c=$(window).innerHeight();a=$("body").height()+40;b=this.el.offset().top-(c>>1)+75;b=Math.max(0,Math.min(a-c,b));return $("html, body").animate({scrollTop:b},1500,"easeOutExpo")};return b}(Backbone.View);f=function(a){function b(){b.__super__.constructor.apply(this,arguments)}n(b,a);b.prototype.model=h;b.prototype.sync=function(a,b,c){c.dataType="jsonp";return Backbone.sync(a,b,c)};b.prototype.parse=function(a){var b,c,d,e,f,g,h,i,j,k,l;e=[];k=a.feed.entry;for(g=0,i=k.length;g<i;g++){b=k[g];d=b["im:image"];c={artistName:b["im:artist"].label,playlistName:b["im:collection"]["im:name"].label,itemName:b["im:name"].label,imageUrl:d.pop().label};l=b.link;for(h=0,j=l.length;h<j;h++){f=l[h];switch(f.attributes.type){case"text/html":c.storeUrl=f.attributes.href;break;case"audio/x-m4a":c.audioUrl=f.attributes.href}}e.push(c)}return e};return b}(Backbone.Collection);g=function(a){function b(){this.onPlayComplete=l(this.onPlayComplete,this);this.addAll=l(this.addAll,this);this.addOne=l(this.addOne,this);b.__super__.constructor.apply(this,arguments)}n(b,a);b.prototype.tagName="div";b.prototype.className="playlist";b.prototype.initialize=function(a){this.playlist=new f;this.playlist.url="http://itunes.apple.com/jp/rss/topsongs/limit=300/genre="+a+"/json?callback=?";this.playlist.bind("add",this.addOne);this.playlist.bind("reset",this.addAll);return this.playlist.fetch()};b.prototype.addOne=function(a,b){var c;a.set({order:b});a.bind("complete",this.onPlayComplete);c=new i({model:a});return $(this.el).append(c.render().el)};b.prototype.addAll=function(){this.playlist.each(this.addOne);return $(this.el).append("<div style='clear:both'/>")};b.prototype.onPlayComplete=function(a){var b,c;c=a.get("order");b=this.playlist.at(c+1);return b!=null?b.play():void 0};return b}(Backbone.View);c=function(){function a(a,b){this.onClick=l(this.onClick,this);var c,d,e,f,g;_.extend(this,Backbone.Events);for(f=0,g=b.length;f<g;f++){d=b[f];e=$("<li><a href='/"+d.genreId+"'>"+d.name+"</a></li>");c=$("a",e);c.data("ids",d);c.click(this.onClick);a.append(e)}}a.prototype.onClick=function(a){var b;a.preventDefault();b=$(a.delegateTarget).data("ids");history.pushState(b,b.name,"/"+b.genreId);return this.trigger("select",b)};return a}();a=function(){function a(){this.onResize=l(this.onResize,this);this.onPopState=l(this.onPopState,this);this.onGenreSelect=l(this.onGenreSelect,this);this.changeGenre=l(this.changeGenre,this);j.init($("#volumeSlider"));this.genreMenu=new c($("#genreMenu"),k);this.genreMenu.bind("select",this.onGenreSelect);window.addEventListener("popstate",this.onPopState);window.addEventListener("resize",this.onResize);setTimeout(this.onResize,100)}a.prototype.find=function(){var a,b,c,d,e;c=location.pathname.match(/^\/(\d+)$/);if((c!=null?c.length:void 0)===2){b=parseInt(c[1]);for(d=0,e=k.length;d<e;d++){a=k[d];if(a.genreId===b)return a}}else if(location.pathname==="/")return k[0];return null};a.prototype.changeGenre=function(a){var b,c;(b=e.current)!=null&&b.stop();(c=this.current)!=null&&c.remove();this.current=new g(a.genreId);document.title="itms300 - "+a.name;$("#genreName").text(a.name);$("#playlist").append(this.current.el);return this.onResize()};a.prototype.onGenreSelect=function(a){return this.changeGenre(a)};a.prototype.onPopState=function(a){return this.changeGenre(this.find())};a.prototype.onResize=function(a){var b,c,d;d=$("body").width();c=~~((d-50)/150);b=d-c*150>>1;$("#playlist").css({width:150*c+"px","margin-left":b+"px"});$(".navbar-inner").css({width:150*c+"px","padding-left":b+"px","padding-right":b+"px"});$("#footer-inner").width(150*c+"px");$("body").css({"background-position":b+"px 65px"});return $("#status").css({width:$("#volume").offset().left-$("#status").offset().left-100+"px"})};return a}();$(function(){return new a})})).call(this);